<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Tickets</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f5f5;
    }

    .booking-card {
      max-width: 700px;
      margin: 40px auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .booking-card h2 {
      font-weight: 600;
      margin-bottom: 25px;
      color: #e50914;
    }

    .form-label {
      font-weight: 500;
    }

    .total-price {
      font-weight: 600;
      font-size: 1.2rem;
      color: #e50914;
    }

    .btn-book {
      background-color: #e50914;
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 6px;
      transition: 0.3s;
    }

    .btn-book:hover {
      background-color: #b0060f;
    }

    .alert-message {
      font-weight: 500;
    }
  </style>
</head>

<body>

  <%- include('../partials/header.ejs') %>

    <% if (!user || !user._id) { %>
      <div class="alert alert-danger mt-4 text-center">User not logged in. Please log in to book tickets.</div>
      <% } else { %>
        <div class="booking-card">
          <h2 class="text-center">Book Your Tickets</h2>
          <form id="bookingForm" method="POST" action="/booking">

            <!-- User Info -->
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" name="userId" value="<%= user._id %>" hidden>
              <input type="text" class="form-control" value="<%= user.username %>" readonly>
            </div>

            <!-- Movie Info -->
            <div class="mb-3">
              <label class="form-label">Movie</label>

              <% if (typeof movie !=="undefined" && movie && movie._id) { %>
                <!-- Show the pre-selected movie -->
                <input type="hidden" name="movieId" value="<%= movie._id %>">
                <input type="text" class="form-control" value="<%= movie.title %>" readonly>

                <% } else if (typeof allMovies !=="undefined" && allMovies.length> 0) { %>
                  <!-- Auto-fill with first available movie -->
                  <input type="hidden" name="movieId" value="<%= allMovies[0]._id %>">
                  <input type="text" class="form-control" value="<%= allMovies[0].title %>" readonly>

                  <% } else { %>
                    <!-- No movies available, allow manual entry -->
                    <input type="text" name="movieTitle" class="form-control" placeholder="Enter movie name">
                    <% } %>
            </div>



            <!-- Theater -->
            <div class="mb-3">
              <label class="form-label">Theater</label>
              <select name="theater" class="form-select" required>
                <option value="" disabled selected>Select theater</option>
                <option value="PVR Cinemas">PVR Cinemas</option>
                <option value="INOX">INOX</option>
                <option value="Cinepolis">Cinepolis</option>
                <option value="Carnival">Carnival</option>
              </select>
            </div>

            <!-- City -->
            <div class="mb-3">
              <label class="form-label">City</label>
              <select name="city" class="form-select" required>
                <option value="" disabled selected>Select city</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Delhi">Delhi</option>
                <option value="Bengaluru">Bengaluru</option>
                <option value="Chennai">Chennai</option>
                <option value="Hyderabad">Hyderabad</option>
                <option value="Ahmedabad">Ahmedabad</option>
              </select>
            </div>

            <!-- Showtime -->
            <div class="mb-3">
              <label class="form-label">Showtime</label>
              <select name="showtime" class="form-select" required>
                <option value="" disabled selected>Select showtime</option>
                <option value="2025-08-19T10:00">10:00 AM</option>
                <option value="2025-08-19T13:00">01:00 PM</option>
                <option value="2025-08-19T16:00">04:00 PM</option>
                <option value="2025-08-19T19:00">07:00 PM</option>
                <option value="2025-08-19T22:00">10:00 PM</option>
              </select>
            </div>


            <!-- Seats -->
            <div class="mb-3">
              <label class="form-label">Seats</label>
              <input type="number" name="seats" id="seatsInput" class="form-control" min="1" value="1" required>
            </div>

            <!-- Total Price -->
            <div class="mb-3">
              <label class="form-label">Total Price</label>
              <input type="text" id="priceInput" name="price" class="form-control total-price" value="250" readonly>
            </div>

            <button type="submit" class="btn btn-book w-100 border border-2 border-danger">Book Now</button>
          </form>

          <div id="bookingMessage" class="mt-3 alert-message text-center"></div>
        </div>
        <% } %>

          <%- include('../partials/footer.ejs') %>

            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

            <!-- Booking Form Script -->
            <script>
              const form = document.getElementById('bookingForm');
              const messageDiv = document.getElementById('bookingMessage');
              const seatsInput = document.getElementById('seatsInput');
              const priceInput = document.getElementById('priceInput');

              // Auto-calculate price (₹250 per seat)
              seatsInput.addEventListener('input', function () {
                const seats = parseInt(seatsInput.value) || 1;
                priceInput.value = seats * 250;
              });

              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(form).entries());

                if (!data.userId || !data.movieId) {
                  messageDiv.innerHTML = `<p class="text-danger">❌ Please log in and select a movie to book.</p>`;
                  return;
                }

                const res = await fetch('/booking', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                  messageDiv.innerHTML = `<p class="text-success">✅ Booking confirmed for ${data.seats} seat(s)</p>`;
                  form.reset();
                  priceInput.value = 250;
                } else {
                  messageDiv.innerHTML = `<p class="text-danger">❌ Booking failed: ${result.message}</p>`;
                }
              });
            </script>
</body>

</html>